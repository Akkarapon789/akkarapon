<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password</title>
  <style>
    body {
      background: linear-gradient(135deg,#2359d6 0%, #bfc69a 55%, #f6df60 100%);
      display:flex;align-items:center;justify-content:center;
      height:100vh;margin:0;font-family:Arial, sans-serif;
    }
    .card {
      width:360px;background:#fff;border-radius:12px;padding:24px;
      box-shadow:0 10px 24px rgba(0,0,0,0.1);text-align:center;
    }
    h1 { margin-bottom:12px }
    input {
      width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;
      border-radius:6px;font-size:14px;
    }
    button {
      width:100%;padding:10px;margin-top:12px;border:none;
      border-radius:6px;font-size:15px;cursor:pointer;
    }
    .btn-primary { background:#0b6cff;color:#fff }
    .btn-secondary { background:#f3f4f6;color:#374151;margin-top:6px }
    .notice {
      margin-top:12px;padding:10px;border-radius:6px;
      font-size:14px;display:none;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ตั้งรหัสผ่านใหม่</h1>
    <p>กรอกรหัสผ่านใหม่ของคุณเพื่อรีเซ็ต</p>
    <form id="resetForm">
      <input id="password" type="password" placeholder="รหัสผ่านใหม่" required>
      <input id="confirmPassword" type="password" placeholder="ยืนยันรหัสผ่านใหม่" required>
      <button type="submit" class="btn-primary">บันทึกรหัสผ่านใหม่</button>
      <button type="button" class="btn-secondary" id="cancelBtn">ยกเลิก</button>
    </form>
    <div id="notice" class="notice"></div>
  </div>

  <script>
    const form = document.getElementById("resetForm");
    const passwordEl = document.getElementById("password");
    const confirmEl = document.getElementById("confirmPassword");
    const notice = document.getElementById("notice");

    const apiUrl = "http://localhost:3000/api/auth/reset-password"; // <-- API จริง

    function showNotice(msg, success=false) {
      notice.textContent = msg;
      notice.style.display = "block";
      notice.style.background = success ? "#e0f7e9" : "#fdecea";
      notice.style.color = success ? "#065f46" : "#b91c1c";
    }

    document.getElementById("cancelBtn").addEventListener("click", ()=>{
      window.location.href = "/Login/Login.html";
    });

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const pass = passwordEl.value.trim();
      const confirm = confirmEl.value.trim();
      if(pass.length < 6) return showNotice("รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร");
      if(pass !== confirm) return showNotice("รหัสผ่านทั้งสองช่องไม่ตรงกัน");

      // ดึง token จาก URL เช่น /reset-password?token=xxxxx
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");
      if(!token) return showNotice("ไม่พบโทเค็นรีเซ็ต", false);

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, newPassword: pass })
        });
        const result = await response.json();
        if(response.ok){
          showNotice("ตั้งรหัสผ่านใหม่สำเร็จ! คุณสามารถล็อกอินได้แล้ว", true);
          form.querySelectorAll("input, button").forEach(el=>el.disabled = true);
        } else {
          showNotice(result.message || "เกิดข้อผิดพลาด", false);
        }
      } catch(err) {
        console.error(err);
        showNotice("ไม่สามารถเชื่อมต่อ API ได้", false);
      }
    });
  </script>
</body>
</html>
