<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cart</title>

  <!-- Bootstrap CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* เล็กน้อยเพื่อจัดตำแหน่ง badge และขนาดไอคอน */
    .cart-btn {
      background: transparent;
      border: none;
      padding: 0.25rem 0.35rem;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
    }
    .cart-btn svg { width: 26px; height: 26px; }
    /* ปรับตำแหน่ง badge ให้อยู่มุมขวาบนของไอคอน */
    .cart-badge {
      font-size: 0.7rem;
      line-height: 1;
      min-width: 1.35rem;
      height: 1.35rem;
      padding: 0 0.35rem;
    }
  </style>
</head>
<body>

  <!-- ตัวอย่างส่วน header/ไอคอนตะกร้า -->
  <div class="header-with-search__cart-wrapper p-3 d-flex justify-content-end">
    <!-- เราใช้ button แทน anchor เพื่อให้ควบคุมพฤติกรรมด้วย JS ได้ง่ายและ semantic ถูกต้อง -->
    <button id="cartButton"
            class="cart-btn"
            aria-controls="cartOffcanvas"
            aria-expanded="false"
            aria-label="Shopping cart — คลิกเพื่อเปิดตะกร้าหรือเข้าสู่ระบบ">
      <!-- SVG ไอคอน (จากตัวอย่างของคุณ) -->
      <svg viewBox="0 0 26.6 25.6" class="shopee-svg-icon navbar__link-icon icon-shopping-cart-2" aria-hidden="true" focusable="false">
        <title>Shopping Cart Icon</title>
        <polyline fill="none" points="2 1.7 5.5 1.7 9.6 18.3 21.2 18.3 24.6 6.1 7 6.1"
                  stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="2.5"></polyline>
        <circle cx="10.7" cy="23" r="2.2" stroke="none"></circle>
        <circle cx="19.7" cy="23" r="2.2" stroke="none"></circle>
      </svg>

      <!-- จำนวนสินค้าในตะกร้า (badge) -->
      <span id="cartCount" class="badge bg-danger text-white rounded-pill cart-badge">0</span>

      <!-- สำหรับ screen reader -->
      <span class="visually-hidden">Shopping Cart — โปรดเข้าสู่ระบบเพื่อดูตะกร้า</span>
    </button>

    <!-- Fallback สำหรับผู้ใช้ JS ปิด (noscript) -->
    <noscript>
      <a class="btn btn-outline-primary ms-2" href="/buyer/login?from_source=mini_cart_btn&next=/">เข้าสู่ระบบ</a>
    </noscript>
  </div>

  <!-- Offcanvas (drawer) ของตะกร้า — ใช้ Bootstrap Offcanvas -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="cartOffcanvasLabel">ตะกร้าสินค้า</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="ปิด"></button>
    </div>
    <div class="offcanvas-body">
      <!-- เนื้อหาตะกร้า (จะเติมด้วย JS เมื่อผู้ใช้ล็อกอิน / มีของในตะกร้า) -->
      <div id="cartBody">
        <p class="text-muted">ตะกร้าว่าง — เพิ่มสินค้าลงในตะกร้า</p>
      </div>

      <!-- ตัวอย่างปุ่มไปชำระเงิน -->
      <div class="mt-3">
        <button id="checkoutBtn" class="btn btn-warning w-100" disabled>ไปชำระเงิน</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (bundle includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // === CONFIG / ตัวอย่าง: เปลี่ยนค่าเหล่านี้ตาม logic ของคุณ ===
    // ในระบบจริง ให้ตรวจสอบสถานะการล็อกอินจาก session / cookie / API
    let isLoggedIn = false; // ตั้งเป็น true เพื่อทดสอบว่า "ล็อกอินแล้ว"
    let loginUrl = '/buyer/login?from_source=mini_cart_btn&next=' + encodeURIComponent(window.location.href);

    // ตัวอย่างข้อมูลตะกร้า (ในระบบจริง ดึงจาก server / localStorage / API)
    const demoCart = [
      { id: 1, name: 'หนังสือ: เรียน JavaScript', qty: 1, price: 250 },
      { id: 2, name: 'แก้วเก็บความเย็น', qty: 2, price: 199 }
    ];

    // === เลือก element ===
    const cartButton = document.getElementById('cartButton');
    const cartCount = document.getElementById('cartCount');
    const cartOffcanvasEl = document.getElementById('cartOffcanvas');
    const cartBody = document.getElementById('cartBody');
    const checkoutBtn = document.getElementById('checkoutBtn');

    // สร้าง Bootstrap Offcanvas instance (ต้องหลัง load bootstrap)
    const cartOffcanvas = new bootstrap.Offcanvas(cartOffcanvasEl);

    // ฟังก์ชันอัปเดต badge จำนวนสินค้า
    function updateCartCount(count) {
      cartCount.textContent = count;
      if (count > 0) {
        cartCount.classList.remove('bg-secondary');
        cartCount.classList.add('bg-danger');
        checkoutBtn.disabled = false;
      } else {
        cartCount.classList.remove('bg-danger');
        cartCount.classList.add('bg-secondary');
        checkoutBtn.disabled = true;
      }
    }

    // ฟังก์ชันเติมเนื้อหาในตะกร้า
    function renderCartItems(items) {
      if (!items || items.length === 0) {
        cartBody.innerHTML = '<p class="text-muted">ตะกร้าว่าง — เพิ่มสินค้าลงในตะกร้า</p>';
        updateCartCount(0);
        return;
      }

      let html = '<ul class="list-group">';
      let total = 0;
      items.forEach(it => {
        total += it.price * it.qty;
        html += `
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div class="ms-2 me-auto">
              <div class="fw-bold">${escapeHtml(it.name)}</div>
              จำนวน: ${it.qty} × ${formatCurrency(it.price)}
            </div>
            <div class="text-end">${formatCurrency(it.price * it.qty)}</div>
          </li>
        `;
      });
      html += `</ul>
               <div class="mt-3 d-flex justify-content-between">
                 <strong>รวม</strong>
                 <strong>${formatCurrency(total)}</strong>
               </div>`;
      cartBody.innerHTML = html;
      updateCartCount(items.reduce((s, i) => s + i.qty, 0));
    }

    // ปุ่ม cart: ถ้ายังไม่ล็อกอิน -> ไปหน้า login (พร้อม next), ถ้าล็อกอิน -> เปิด offcanvas
    cartButton.addEventListener('click', (e) => {
      if (!isLoggedIn) {
        // Redirect to login (ในระบบจริงเปลี่ยน loginUrl ให้ถูกต้อง)
        window.location.href = loginUrl;
        return;
      }
      // ถ้าล็อกอินแล้ว เตรียมข้อมูลตะกร้า (fetch จาก API ในระบบจริง)
      // ที่นี่ใช้ demoCart เป็นตัวอย่าง
      renderCartItems(demoCart);
      cartOffcanvas.show();
    });

    // ถ้าต้องการให้เปิดได้จากโค้ดอื่น ๆ
    // ตัวอย่าง: เปิดตะกร้าโดยตรง (เฉพาะกรณีล็อกอิน)
    function openCartIfLoggedIn() {
      if (!isLoggedIn) { window.location.href = loginUrl; return; }
      renderCartItems(demoCart);
      cartOffcanvas.show();
    }

    // Utility: format currency แบบง่าย
    function formatCurrency(n) {
      return n.toLocaleString('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 });
    }

    // Utility: escape HTML (ป้องกัน XSS ในกรณีข้อมูลมาจากภายนอก)
    function escapeHtml(str) {
      return String(str).replace(/[&<>"'`=\/]/g, function (s) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '/': '&#x2F;',
          '`': '&#x60;',
          '=': '&#x3D;'
        })[s];
      });
    }

    // เริ่มต้น: ถ้าอยากโชว์จำนวนจาก demo
    // (ในระบบจริง ให้อัปเดตจาก API / localStorage)
    if (isLoggedIn) {
      renderCartItems(demoCart);
    } else {
      updateCartCount(0); // แสดง 0 ถ้าไม่ล็อกอิน
    }

    // ตัวอย่าง: ปุ่ม checkout ไปหน้าชำระเงิน (ในระบบจริงต้องเปลี่ยน url)
    checkoutBtn.addEventListener('click', () => {
      if (!isLoggedIn) {
        window.location.href = loginUrl; // เก็บ next param ให้ไปชำระเงินหลังล็อกอิน
        return;
      }
      // ในระบบจริง redirect ไป checkout page
      window.location.href = '/checkout';
    });
  </script>
</body>
</html>